<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 10: Consistent Error Handling | MAD9124</title>
    <meta name="description" content="Mobile API Development">
    
    
    <link rel="preload" href="/assets/css/0.styles.084d7c4c.css" as="style"><link rel="preload" href="/assets/js/app.71c37e52.js" as="script"><link rel="preload" href="/assets/js/15.c6f416e9.js" as="script"><link rel="preload" href="/assets/js/5.d875dd4e.js" as="script"><link rel="prefetch" href="/assets/js/2.6573b30c.js"><link rel="prefetch" href="/assets/js/3.bf2a64fb.js"><link rel="prefetch" href="/assets/js/4.db9b657e.js"><link rel="prefetch" href="/assets/js/6.c8e95fd0.js"><link rel="prefetch" href="/assets/js/7.38090071.js"><link rel="prefetch" href="/assets/js/8.bbb7f9ec.js"><link rel="prefetch" href="/assets/js/9.4519aded.js"><link rel="prefetch" href="/assets/js/10.0fd3f93c.js"><link rel="prefetch" href="/assets/js/11.ae8c26a3.js"><link rel="prefetch" href="/assets/js/12.57f9b125.js"><link rel="prefetch" href="/assets/js/13.a589cf42.js"><link rel="prefetch" href="/assets/js/14.3119106c.js"><link rel="prefetch" href="/assets/js/16.60cf80b9.js"><link rel="prefetch" href="/assets/js/17.e03883a2.js"><link rel="prefetch" href="/assets/js/18.ca360324.js"><link rel="prefetch" href="/assets/js/19.59eeaff9.js"><link rel="prefetch" href="/assets/js/20.0d907809.js"><link rel="prefetch" href="/assets/js/21.d1a45bec.js"><link rel="prefetch" href="/assets/js/22.56312e0c.js"><link rel="prefetch" href="/assets/js/23.901d07dd.js"><link rel="prefetch" href="/assets/js/24.c90462b4.js"><link rel="prefetch" href="/assets/js/25.0c2b62eb.js"><link rel="prefetch" href="/assets/js/26.4bdddc91.js"><link rel="prefetch" href="/assets/js/27.894b645a.js"><link rel="prefetch" href="/assets/js/28.82a5b267.js"><link rel="prefetch" href="/assets/js/29.a60cef02.js"><link rel="prefetch" href="/assets/js/30.21c01a63.js"><link rel="prefetch" href="/assets/js/31.607866af.js"><link rel="prefetch" href="/assets/js/32.59c25f3c.js"><link rel="prefetch" href="/assets/js/33.996c9705.js"><link rel="prefetch" href="/assets/js/34.6923aabe.js"><link rel="prefetch" href="/assets/js/35.089a238b.js"><link rel="prefetch" href="/assets/js/36.17d82978.js">
    <link rel="stylesheet" href="/assets/css/0.styles.084d7c4c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/overview/" class="nav-link">Overview</a></div><div class="nav-item"><a href="/deliverables/" class="nav-link">Deliverables</a></div><div class="nav-item"><a href="/modules/" class="nav-link router-link-active">Modules</a></div><div class="nav-item"><a href="/resources/" class="nav-link">Resources</a></div><div class="nav-item"><a href="https://classroom.github.com/classrooms/46425465-mobile-api-development" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/overview/" class="nav-link">Overview</a></div><div class="nav-item"><a href="/deliverables/" class="nav-link">Deliverables</a></div><div class="nav-item"><a href="/modules/" class="nav-link router-link-active">Modules</a></div><div class="nav-item"><a href="/resources/" class="nav-link">Resources</a></div><div class="nav-item"><a href="https://classroom.github.com/classrooms/46425465-mobile-api-development" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/modules/" class="sidebar-link">Table of contents</a></li><li><a href="/modules/week1/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/modules/week2/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/modules/week3/" class="sidebar-link">Week 3: RESTful APIs</a></li><li><a href="/modules/week4/" class="sidebar-link">Week 4: Middleware functions</a></li><li><a href="/modules/week5/" class="sidebar-link">Week 5: Data persistance</a></li><li><a href="/modules/week6/" class="sidebar-link">Week 6: Object Data Modeling</a></li><li><a href="/modules/break-week/" class="sidebar-link">Break Week: 18 FEB - 22 FEB</a></li><li><a href="/modules/week7/" class="sidebar-link">Week 7: Data security</a></li><li><a href="/modules/week8/" class="sidebar-link">Week 8: Access Control with JWT</a></li><li><a href="/modules/week9/" class="sidebar-link">Week 9: JWT Review</a></li><li><a href="/modules/week10/" class="active sidebar-link">Week 10: Consistent Error Handling</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/week10/#agenda" class="sidebar-link">Agenda</a></li><li class="sidebar-sub-header"><a href="/modules/week10/#enhanced-validation" class="sidebar-link">Enhanced Validation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/week10/#unique-properties" class="sidebar-link">Unique properties</a></li><li class="sidebar-sub-header"><a href="/modules/week10/#email-address-format" class="sidebar-link">Email address format</a></li><li class="sidebar-sub-header"><a href="/modules/week10/#timestamps" class="sidebar-link">Timestamps</a></li><li class="sidebar-sub-header"><a href="/modules/week10/#setter-functions" class="sidebar-link">Setter Functions</a></li></ul></li><li class="sidebar-sub-header"><a href="/modules/week10/#error-handler-middleware" class="sidebar-link">Error Handler Middleware</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/week10/#validation-error" class="sidebar-link">Validation error</a></li><li class="sidebar-sub-header"><a href="/modules/week10/#refactor-router-modules" class="sidebar-link">Refactor Router Modules</a></li><li class="sidebar-sub-header"><a href="/modules/week10/#error-logging" class="sidebar-link">Error Logging</a></li><li class="sidebar-sub-header"><a href="/modules/week10/#register-the-error-handers" class="sidebar-link">Register the error handers</a></li></ul></li><li class="sidebar-sub-header"><a href="/modules/week10/#custom-exception-classes" class="sidebar-link">Custom Exception Classes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/week10/#resource-not-found" class="sidebar-link">Resource not found</a></li></ul></li><li class="sidebar-sub-header"><a href="/modules/week10/#for-next-week" class="sidebar-link">For next week</a></li></ul></li><li><a href="/modules/week11/" class="sidebar-link">Week 11: Production Preparation</a></li><li><a href="/modules/week12/" class="sidebar-link">Week 12: Testing</a></li><li><a href="/modules/week13/" class="sidebar-link">Week 13: Production Deployment</a></li><li><a href="/modules/week14/" class="sidebar-link">Week 14: Advanced topics</a></li><li><a href="/modules/week15/" class="sidebar-link">Week 15: Remedial Lab</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1><span class="week">Week 10</span><br> <span class="title">Consistent Error Handling</span></h1> <div class="warning custom-block"><p class="custom-block-title">Assignment Due</p> <p>Assignment 3 - Authentication - is due <strong>before</strong> noon on Monday, March 25th.
It is worth 5% of your final grade.</p></div> <h2 id="agenda"><a href="#agenda" aria-hidden="true" class="header-anchor">#</a> Agenda</h2> <ul><li>AMA (10 mins)</li> <li>No Quiz Today</li> <li>Enhanced Validation (40 mins)</li> <li>Break (10 mins)</li> <li>Error Handling Middleware (50 mins)</li> <li>Break (10 mins)</li> <li>Review Final Project (15 mins)</li> <li>Lab Time</li></ul> <h2 id="enhanced-validation"><a href="#enhanced-validation" aria-hidden="true" class="header-anchor">#</a> Enhanced Validation</h2> <h3 id="unique-properties"><a href="#unique-properties" aria-hidden="true" class="header-anchor">#</a> Unique properties</h3> <p>Last week we looked at how to manually check if a property value, like email, has already been stored in the target collection. We used the Mongoose <code>.countDocuments()</code> method in the route handler. While it is important to understand how and why that works, there is a better way to handle this.</p> <p>In a larger application, we may well have several properties with a <code>unique: true</code> constraint set in the schema, so a common middleware function would be a good idea. We also talked about the OOP Expert Principle and this kind of validation check really belongs in the Model class.</p> <p>As it happens there is a Mongoose schema plugin made just for this use case. It is called <a href="https://www.npmjs.com/package/mongoose-unique-validator" target="_blank" rel="noopener noreferrer">mongoose-unique-validator<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Let's install it in our project.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> mongoose-unique-validator
</code></pre></div><p>Then we can implement it in the <code>/models/User</code> module. Require it at the top and then register the plugin right near the bottom, after all of the other <code>schema</code> definition code, but before creating and exporting the <code>Model</code>.</p> <div class="language-js extra-class"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> uniqueValidator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose-unique-validator'</span><span class="token punctuation">)</span>

<span class="token comment">// ... the rest of the code we already had</span>

schema<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>uniqueValidator<span class="token punctuation">)</span>

<span class="token comment">// register the plugin before these last two lines</span>
<span class="token keyword">const</span> Model <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Person'</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Model
</code></pre></div><p>The <code>schmea.plugin()</code> method takes two arguments: the plugin module and an optional configuration object. In this case the configuration object let's us set a custom error message.</p> <p>The <code>message</code> property can be set to either a string or a function that returns a string. Let's create a function that returns a specific message for <code>email</code> properties and a generic message for any other property with a <code>unique:true</code> schema setting.</p> <div class="language-js extra-class"><pre class="language-js"><code>schema<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>uniqueValidator<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  message<span class="token punctuation">:</span> props <span class="token operator">=&gt;</span>
    props<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'email'</span>
      <span class="token operator">?</span> <span class="token template-string"><span class="token string">`The email address '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' is already registerd.`</span></span>
      <span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`The </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> must be unique. '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' is already in use.`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="email-address-format"><a href="#email-address-format" aria-hidden="true" class="header-anchor">#</a> Email address format</h3> <p>While we are looking at the <code>email</code> property, it would be nice if there was a simple way to validate that the given email address is in fact a correctly formatted email. We could go read the RFC spec and figure out a complicated RegEx comparison, but ... you guessed it. Somebody has already done the hard work.</p> <p>There is a widely used NPM library called <a href="https://www.npmjs.com/package/validator" target="_blank" rel="noopener noreferrer">validator<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that among many other options, has a reliable method for checking email addresses. Let's add it as a dependancy of our project.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> validator
</code></pre></div><p>Now we can use it in a custom validation method on our schema. Mongoose allows us to set a function as the value for the <code>validate</code> property, or if we want to set a custom error message, we can set an object with a <code>validator</code> function that returns a boolean and a <code>message</code> function that returns a string. This is the approach that we will take.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...other props</span>
  email<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    trim<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    unique<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    validate<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      validator<span class="token punctuation">:</span> value <span class="token operator">=&gt;</span> validator<span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
      message<span class="token punctuation">:</span> props <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not a valid email address.`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="timestamps"><a href="#timestamps" aria-hidden="true" class="header-anchor">#</a> Timestamps</h3> <p>Another common schema requirement is to have the application automatically set two timestamp properties on the document object: <code>createdAt</code> and <code>updatedAt</code>.</p> <p>This is easily accomplished with Mongoose by setting <code>timestamps: true</code> in the optional second argument to the Schema constructor function. This <a href="https://mongoosejs.com/docs/guide.html#options" target="_blank" rel="noopener noreferrer">options object<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> has nearly 2 dozen settings to modify the default behaviour of our document schema.</p> <p>Turn on the <a href="https://mongoosejs.com/docs/guide.html#timestamps" target="_blank" rel="noopener noreferrer">timestamps option<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for the User model.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// all of the property definitions and validators</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="setter-functions"><a href="#setter-functions" aria-hidden="true" class="header-anchor">#</a> Setter Functions</h3> <p>The Mongoose schema definition make's it simple to define <a href="https://mongoosejs.com/docs/api.html#schematype_SchemaType-set" target="_blank" rel="noopener noreferrer">setter methods<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that can transform the input data before it is stored in MongoDB, or before using it in a query. This is better illustrated with a couple of examples.</p> <h4 id="normalize-email"><a href="#normalize-email" aria-hidden="true" class="header-anchor">#</a> Normalize Email</h4> <p>When storing a user's email address, particularly if using it as their username for authentication, it is a good practice to always convert it lowercase. e.g. &quot;MICKEY.Mouse@Disney.com&quot; should be stored and compared as &quot;mickey.mouse@disney.com&quot;.</p> <p>We can add a setter function to do this.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  email<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    trim<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    maxlength<span class="token punctuation">:</span> <span class="token number">512</span><span class="token punctuation">,</span>
    required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    unique<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">:</span> value <span class="token operator">=&gt;</span> value<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    validate<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      validator<span class="token punctuation">:</span> value <span class="token operator">=&gt;</span> validator<span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
      message<span class="token punctuation">:</span> props <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not a valid email address.`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="force-integer"><a href="#force-integer" aria-hidden="true" class="header-anchor">#</a> Force Integer</h4> <p>The <code>Number</code> type in Mongoose, like JavaScript, can hold integers or floating point values. There are times when we need to be sure that the value stored is in fact an integer -- for example, when storing monetary values for a credit card payment system like Stripe.</p> <p>We can add a setter function to always round up to the next integer so that &quot;100.01&quot; cents would be stored as &quot;101&quot; cents.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  price<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Number<span class="token punctuation">,</span>
    min<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">:</span> value <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="error-handler-middleware"><a href="#error-handler-middleware" aria-hidden="true" class="header-anchor">#</a> Error Handler Middleware</h2> <p>OK. So now we have better input validation, but most of the code examples that we have seen so far are not giving the client helpful error messages. We have been masking them in generic &quot;500 Server Error&quot; messages.</p> <p>It is time to fix that!</p> <p>Express let's us define error handler middleware to help clean up the route handlers and ensure consistent response formatting. When another middleware function calls <code>next(error)</code> passing an error object as a argument, Express will short-circuit the request pipeline and jump to the first registered error handler function.</p> <div class="tip custom-block"><p class="custom-block-title">Function Signature</p> <p>Remember Express error handler middleware functions look just like ordinary middleware, but with one extra argument.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">errorHandler</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre></div></div> <p>Great, but how does that help with our route handler functions? Well, remember when I told you that almost everything in Express is a middleware function? That includes route handlers. We just have to add the <code>next</code> argument to the function signature.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// this</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/auth/users'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// becomes</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/auth/users'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>OK. OK. OK. Let's build the thing!</p> <p>Create a new file called <code>errorHandler.js</code> in the <code>/middleware</code> folder and add this starter code that will implement a default &quot;500 Server Error&quot;.</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span>errors<span class="token punctuation">:</span> <span class="token punctuation">[</span>err<span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token number">500</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="validation-error"><a href="#validation-error" aria-hidden="true" class="header-anchor">#</a> Validation error</h3> <p>Now let's add in some logic to check for <a href="https://mongoosejs.com/docs/validation.html#validation-errors" target="_blank" rel="noopener noreferrer">Mongoose validation errors<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and format them according to the JSON:API specification.</p> <blockquote><p>Mongoose errors returned after failed validation contain an <code>errors</code> object whose values are <code>ValidatorError</code> objects. Each ValidatorError has <code>kind</code>, <code>path</code>, <code>value</code>, and <code>message</code> properties.</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// An example error object might look like this</span>

error <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... some other properties</span>
  errors<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    password<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`'password' is required`</span></span><span class="token punctuation">,</span>
      kind<span class="token punctuation">:</span> <span class="token string">'Invalid password'</span><span class="token punctuation">,</span>
      path<span class="token punctuation">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span>
      value<span class="token punctuation">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    email<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token string">&quot;The email address 'm.mouse@disney.com' is already registerd.&quot;</span><span class="token punctuation">,</span>
      kind<span class="token punctuation">:</span> <span class="token string">'Invalid email'</span><span class="token punctuation">,</span>
      path<span class="token punctuation">:</span> <span class="token string">'email'</span><span class="token punctuation">,</span>
      value<span class="token punctuation">:</span> <span class="token string">'m.mouse@disney.com'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We need to iterate over those ValidatorError objects and transform them into the JSON:API format like this.</p> <div class="language-js extra-class"><pre class="language-js"><code>errors <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    status<span class="token punctuation">:</span> <span class="token string">'Bad Request'</span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token string">'400'</span><span class="token punctuation">,</span>
    title<span class="token punctuation">:</span> <span class="token string">'Validation Error'</span><span class="token punctuation">,</span>
    detail<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`'password' is required`</span></span><span class="token punctuation">,</span>
    source<span class="token punctuation">:</span> <span class="token punctuation">{</span>pointer<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`/data/attributes/password`</span></span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    status<span class="token punctuation">:</span> <span class="token string">'Bad Request'</span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token string">'400'</span><span class="token punctuation">,</span>
    title<span class="token punctuation">:</span> <span class="token string">'Validation Error'</span><span class="token punctuation">,</span>
    detail<span class="token punctuation">:</span> <span class="token string">&quot;The email address 'm.mouse@disney.com' is already registerd.&quot;</span><span class="token punctuation">,</span>
    source<span class="token punctuation">:</span> <span class="token punctuation">{</span>pointer<span class="token punctuation">:</span> <span class="token string">'/data/attributes/email'</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'m.mouse@disney.com'</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>We can use JavaScript's <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_objects/Object/values" target="_blank" rel="noopener noreferrer">Object.values()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> method to extract the various ValidatorError objects into an array and then use the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map" target="_blank" rel="noopener noreferrer">Array.map()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to loop over them and return a new array of properly formatted error objects.</p> <p>At the top of the module, create a helper function to do the formatting.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">formatValidationErrors</span> <span class="token operator">=</span> errors <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    status<span class="token punctuation">:</span> <span class="token string">'Bad Request'</span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token string">'400'</span><span class="token punctuation">,</span>
    title<span class="token punctuation">:</span> <span class="token string">'Validation Error'</span><span class="token punctuation">,</span>
    detail<span class="token punctuation">:</span> e<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
    source<span class="token punctuation">:</span> <span class="token punctuation">{</span>pointer<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`/data/attributes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> e<span class="token punctuation">.</span>value<span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now in our main error handler function we need to check if we have a Mongoose validation error and if so, call the formatter function to set the <code>payload</code> variable. Otherwise, we will asume that it is a standard JavaScript error object and wrap it in an array.</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isValidationError <span class="token operator">=</span>
    err<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'ValidationError'</span>

  <span class="token keyword">const</span> payload <span class="token operator">=</span> isValidationError <span class="token operator">?</span> <span class="token function">formatValidationErrors</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>errors<span class="token punctuation">)</span> <span class="token punctuation">:</span> err
  <span class="token keyword">const</span> code <span class="token operator">=</span> isValidationError <span class="token operator">?</span> <span class="token number">400</span> <span class="token punctuation">:</span> <span class="token number">500</span>

  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>errors<span class="token punctuation">:</span> payload<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Almost done. What about other kinds of errors — e.g. a resource not found error?</p> <p>Let's add an option to the <code>code</code> assignment that checks if the <code>err</code> object has a <code>code</code> property and if it does we'll use that instead of the default '500'.</p> <p><img src="/assets/img/ternary-expression-with-default-value.9f56af5a.png" alt="const code = isValidationError ? 400 : err.code || 500"></p> <h3 id="refactor-router-modules"><a href="#refactor-router-modules" aria-hidden="true" class="header-anchor">#</a> Refactor Router Modules</h3> <p>That is looking good, but we still need to update our route handlers to take advantage of this new capability. Let's refactor the &quot;register user&quot; route handler from last week.</p> <h4 id="before"><a href="#before" aria-hidden="true" class="header-anchor">#</a> Before</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Register a new user</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> newUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">)</span>
    <span class="token keyword">const</span> itExists <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">countDocuments</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token punctuation">:</span> newUser<span class="token punctuation">.</span>email<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>itExists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        errors<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            status<span class="token punctuation">:</span> <span class="token string">'Bad Request'</span><span class="token punctuation">,</span>
            code<span class="token punctuation">:</span> <span class="token string">'400'</span><span class="token punctuation">,</span>
            title<span class="token punctuation">:</span> <span class="token string">'Validation Error'</span><span class="token punctuation">,</span>
            detail<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`Email address '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newUser<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' is already registered.`</span></span><span class="token punctuation">,</span>
            source<span class="token punctuation">:</span> <span class="token punctuation">{</span>pointer<span class="token punctuation">:</span> <span class="token string">'/data/attributes/email'</span><span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> newUser<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> newUser<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Error saving new user: '</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      errors<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          status<span class="token punctuation">:</span> <span class="token string">'Server error'</span><span class="token punctuation">,</span>
          code<span class="token punctuation">:</span> <span class="token string">'500'</span><span class="token punctuation">,</span>
          title<span class="token punctuation">:</span> <span class="token string">'Problem saving document to the database.'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="changes-to-this-code"><a href="#changes-to-this-code" aria-hidden="true" class="header-anchor">#</a> Changes to this code</h4> <ol><li><p>Update the function arguments to accept the <code>next</code> function being passed in.</p></li> <li><p>Now that we are using the <strong>mongoose-unique-validator</strong> plugin, we can drop the unique validation check in the route handler.</p></li> <li><p>We can simplify the <code>catch</code> block by calling <code>next(err)</code> instead of defining and sending the error response here.</p></li></ol> <h4 id="after"><a href="#after" aria-hidden="true" class="header-anchor">#</a> After</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Register a new user</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> newUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">)</span>
    <span class="token keyword">await</span> newUser<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> newUser<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Error saving new user: '</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Much simpler, but we're not quite done.</p> <h3 id="error-logging"><a href="#error-logging" aria-hidden="true" class="header-anchor">#</a> Error Logging</h3> <p>There is another repetetive part of error handling that we can eliminate. Notice that <code>debug</code> statement in the catch block. Instead of writing that out every time we are going to call <code>next(err)</code>, we can create another error handler function to do this for us.</p> <p>This makes it much easier to change how we log these errors in the future. We may want to use a logger library like Winston or Morgan. Or we may want to use a third party service like BugSnag or Rollbar. It is much easier to change if it is being managed from one middleware function.</p> <p>The simplest version would simply <code>console.log()</code> the error and then call <code>next(err)</code> to pass control to the next error handler function. Create a new module called <code>logErrors.js</code> in the <code>/middleware</code> folder.</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now we can simplify our route handler even more ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Register a new user</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>newUser <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> newUser<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>We are down to six lines of code from the 32 that we started with!</strong></p> <p>That is more than an 80% reduction and a real win for readability and maintainability.</p> <h3 id="register-the-error-handers"><a href="#register-the-error-handers" aria-hidden="true" class="header-anchor">#</a> Register the error handers</h3> <p>Now we need to put the two new middleware functions into action.</p> <p>In the main entry module, <strong>app.js</strong>, add the error handler middleware functions to the request handling pipeline. Make sure that they are the last items after all of the other route handlers.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre class="language-js"><code><span class="token string">'use strict'</span>
<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'week8'</span><span class="token punctuation">)</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./startup/database'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-mongo-sanitize'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/auth'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/cars'</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/cars'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/people'</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/people'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middleware/logErrors'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middleware/handleErrors'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3030</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Express is listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ...`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="custom-exception-classes"><a href="#custom-exception-classes" aria-hidden="true" class="header-anchor">#</a> Custom Exception Classes</h2> <p>For common errors that we might want to throw from several places in our application, we can extend the standard JavaScript Error class.</p> <h3 id="resource-not-found"><a href="#resource-not-found" aria-hidden="true" class="header-anchor">#</a> Resource not found</h3> <p>For example, we can standardize the error that we pass to our new error handler middleware for resource not found execptions.</p> <p>Create a new top level folder in your project called <code>exceptions</code>. Create a new module file in that folder called <code>ResourceNotFound.js</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ResourceNotFoundException</span> <span class="token keyword">extends</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ResourceNotFoundException<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'Not found'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token string">'404'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">'Resource does not exist'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>message
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> ResourceNotFoundException
</code></pre></div><p>Then in our route handler code, we can refactor the implementation from this ...</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">'owner'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> car<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>... to this ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> ResourceNotFoundError <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../execptions/ResourceNotFound'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">'owner'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ResourceNotFoundError</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token string">`We could not find a car with id: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
      <span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> car<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>We no longer need the <code>sendResourceNotFoundError()</code> helper function in our route handler modules and we will not accidentally mask other errors by allowing the error handler middleware to correctly format and return the errors.</p> <h2 id="for-next-week"><a href="#for-next-week" aria-hidden="true" class="header-anchor">#</a> For next week</h2> <p>Before next week's class, please read these additional online resources.</p> <ul><li><p><a href="https://mongoosejs.com/docs/validation.html#validation-errors" target="_blank" rel="noopener noreferrer">Mongoose Validation Errors<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://mongoosejs.com/docs/validation.html#validation-errors" target="_blank" rel="noopener noreferrer">NPM Validator Docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="http://javascript.info/keys-values-entries" target="_blank" rel="noopener noreferrer">JavaScript Object.values<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="http://javascript.info/map-set-weakmap-weakset" target="_blank" rel="noopener noreferrer">JavaScript Array.map<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul> <div class="warning custom-block"><p class="custom-block-title">Quiz</p> <p>There will be a short quiz next class. The questions could come from any of the material referenced above.</p></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">3/29/2019, 12:52:34 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/modules/week9/" class="prev">
          Week 9: JWT Review
        </a></span> <span class="next"><a href="/modules/week11/">
          Week 11: Production Preparation
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/15.c6f416e9.js" defer></script><script src="/assets/js/5.d875dd4e.js" defer></script><script src="/assets/js/app.71c37e52.js" defer></script>
  </body>
</html>
