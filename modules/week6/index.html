<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 6: Object Data Modeling | MAD9124</title>
    <meta name="description" content="Mobile API Development">
    
    
    <link rel="preload" href="/assets/css/0.styles.084d7c4c.css" as="style"><link rel="preload" href="/assets/js/app.71c37e52.js" as="script"><link rel="preload" href="/assets/js/26.4bdddc91.js" as="script"><link rel="preload" href="/assets/js/3.bf2a64fb.js" as="script"><link rel="preload" href="/assets/js/5.d875dd4e.js" as="script"><link rel="prefetch" href="/assets/js/2.6573b30c.js"><link rel="prefetch" href="/assets/js/4.db9b657e.js"><link rel="prefetch" href="/assets/js/6.c8e95fd0.js"><link rel="prefetch" href="/assets/js/7.38090071.js"><link rel="prefetch" href="/assets/js/8.bbb7f9ec.js"><link rel="prefetch" href="/assets/js/9.4519aded.js"><link rel="prefetch" href="/assets/js/10.0fd3f93c.js"><link rel="prefetch" href="/assets/js/11.ae8c26a3.js"><link rel="prefetch" href="/assets/js/12.57f9b125.js"><link rel="prefetch" href="/assets/js/13.a589cf42.js"><link rel="prefetch" href="/assets/js/14.3119106c.js"><link rel="prefetch" href="/assets/js/15.c6f416e9.js"><link rel="prefetch" href="/assets/js/16.60cf80b9.js"><link rel="prefetch" href="/assets/js/17.e03883a2.js"><link rel="prefetch" href="/assets/js/18.ca360324.js"><link rel="prefetch" href="/assets/js/19.59eeaff9.js"><link rel="prefetch" href="/assets/js/20.0d907809.js"><link rel="prefetch" href="/assets/js/21.d1a45bec.js"><link rel="prefetch" href="/assets/js/22.56312e0c.js"><link rel="prefetch" href="/assets/js/23.901d07dd.js"><link rel="prefetch" href="/assets/js/24.c90462b4.js"><link rel="prefetch" href="/assets/js/25.0c2b62eb.js"><link rel="prefetch" href="/assets/js/27.894b645a.js"><link rel="prefetch" href="/assets/js/28.82a5b267.js"><link rel="prefetch" href="/assets/js/29.a60cef02.js"><link rel="prefetch" href="/assets/js/30.21c01a63.js"><link rel="prefetch" href="/assets/js/31.607866af.js"><link rel="prefetch" href="/assets/js/32.59c25f3c.js"><link rel="prefetch" href="/assets/js/33.996c9705.js"><link rel="prefetch" href="/assets/js/34.6923aabe.js"><link rel="prefetch" href="/assets/js/35.089a238b.js"><link rel="prefetch" href="/assets/js/36.17d82978.js">
    <link rel="stylesheet" href="/assets/css/0.styles.084d7c4c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/overview/" class="nav-link">Overview</a></div><div class="nav-item"><a href="/deliverables/" class="nav-link">Deliverables</a></div><div class="nav-item"><a href="/modules/" class="nav-link router-link-active">Modules</a></div><div class="nav-item"><a href="/resources/" class="nav-link">Resources</a></div><div class="nav-item"><a href="https://classroom.github.com/classrooms/46425465-mobile-api-development" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/overview/" class="nav-link">Overview</a></div><div class="nav-item"><a href="/deliverables/" class="nav-link">Deliverables</a></div><div class="nav-item"><a href="/modules/" class="nav-link router-link-active">Modules</a></div><div class="nav-item"><a href="/resources/" class="nav-link">Resources</a></div><div class="nav-item"><a href="https://classroom.github.com/classrooms/46425465-mobile-api-development" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/modules/" class="sidebar-link">Table of contents</a></li><li><a href="/modules/week1/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/modules/week2/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/modules/week3/" class="sidebar-link">Week 3: RESTful APIs</a></li><li><a href="/modules/week4/" class="sidebar-link">Week 4: Middleware functions</a></li><li><a href="/modules/week5/" class="sidebar-link">Week 5: Data persistance</a></li><li><a href="/modules/week6/" class="active sidebar-link">Week 6: Object Data Modeling</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/week6/#agenda" class="sidebar-link">Agenda</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#mongoose-models" class="sidebar-link">Mongoose Models</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/week6/#schema" class="sidebar-link">Schema</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#schema-types" class="sidebar-link">Schema Types</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#making-models" class="sidebar-link">Making Models</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#relationships" class="sidebar-link">Relationships</a></li></ul></li><li class="sidebar-sub-header"><a href="/modules/week6/#mongoose-query-methods" class="sidebar-link">Mongoose Query Methods</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/week6/#mongo-query-operators" class="sidebar-link">Mongo Query Operators</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#mongoose-query-helpers" class="sidebar-link">Mongoose Query Helpers</a></li></ul></li><li class="sidebar-sub-header"><a href="/modules/week6/#ex6-1-mongo-cars" class="sidebar-link">EX6-1 Mongo Cars</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/week6/#connect-to-mongodb" class="sidebar-link">Connect to MongoDB</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#car-model" class="sidebar-link">Car Model</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#crud-with-mongoose" class="sidebar-link">CRUD with Mongoose</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#get-api-cars" class="sidebar-link">GET /api/cars</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#post-api-cars" class="sidebar-link">POST /api/cars</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#get-api-cars-id" class="sidebar-link">GET /api/cars/:id</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#patch-api-cars-id" class="sidebar-link">PATCH /api/cars/:id</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#put-api-cars-id" class="sidebar-link">PUT /api/cars/:id</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#delete-api-cars-id" class="sidebar-link">DELETE /api/cars/:id</a></li></ul></li><li class="sidebar-sub-header"><a href="/modules/week6/#ex6-2-car-owner" class="sidebar-link">EX6-2 Car Owner</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/week6/#person-model" class="sidebar-link">Person Model</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#update-car-model-schema" class="sidebar-link">Update Car Model.schema</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#populate-owner" class="sidebar-link">Populate owner</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#people-router" class="sidebar-link">People Router</a></li><li class="sidebar-sub-header"><a href="/modules/week6/#submit-github-repo" class="sidebar-link">Submit GitHub Repo</a></li></ul></li><li class="sidebar-sub-header"><a href="/modules/week6/#for-next-class" class="sidebar-link">For next class</a></li></ul></li><li><a href="/modules/break-week/" class="sidebar-link">Break Week: 18 FEB - 22 FEB</a></li><li><a href="/modules/week7/" class="sidebar-link">Week 7: Data security</a></li><li><a href="/modules/week8/" class="sidebar-link">Week 8: Access Control with JWT</a></li><li><a href="/modules/week9/" class="sidebar-link">Week 9: JWT Review</a></li><li><a href="/modules/week10/" class="sidebar-link">Week 10: Consistent Error Handling</a></li><li><a href="/modules/week11/" class="sidebar-link">Week 11: Production Preparation</a></li><li><a href="/modules/week12/" class="sidebar-link">Week 12: Testing</a></li><li><a href="/modules/week13/" class="sidebar-link">Week 13: Production Deployment</a></li><li><a href="/modules/week14/" class="sidebar-link">Week 14: Advanced topics</a></li><li><a href="/modules/week15/" class="sidebar-link">Week 15: Remedial Lab</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1><span class="week">Week 6</span><br> <span class="title">Object Data Modeling with Mongoose</span></h1> <div class="danger custom-block"><p class="custom-block-title">Quiz 5: Databases <span class="badge tip top" data-v-099ab69c>15 mins</span></p> <p>There will be a quiz today. It will be worth 2% of your final grade.</p></div> <h2 id="agenda"><a href="#agenda" aria-hidden="true" class="header-anchor">#</a> Agenda</h2> <ul><li>AMA (10 min)</li> <li>Quiz (10 min)</li> <li>Mongoose Models (20 mins)</li> <li>Mongoose Query Methods (10 mins)</li> <li>Break (10 min)</li> <li>EX6-1 Mongo Cars (50 min)</li> <li>Break (10 min)</li> <li>EX6-2 Car Owner (50 mins)</li></ul> <h2 id="mongoose-models"><a href="#mongoose-models" aria-hidden="true" class="header-anchor">#</a> Mongoose Models</h2> <p>Mongoose is a Node.js based Object Data Modeling (ODM) library for MongoDB. We use it to abstract away the lower level MongoDB access APIs and manage the shape of our application's resource data structures. This is the M in the MVC software architecture pattern.</p> <p>Mongoose provides two core features to simplify the implementation of a MongoDB backed application.</p> <ol><li><p>The <code>mongoose.model()</code> method is a class factory -- meaning it is a function that returns a new class object which we can then use to instantiate individual document objects. This factory function takes two arguments: the name of the resrouce that this model represents, and a schema object describing the properties of that resource.</p></li> <li><p>The <code>mongoose.Schema</code> class is used to define the expected shape of resource properties -- their names, types, and validation limits.</p></li></ol> <h3 id="schema"><a href="#schema" aria-hidden="true" class="header-anchor">#</a> Schema</h3> <p>A model schema could be a simple object specifying the property names and types.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  age<span class="token punctuation">:</span> Number
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Or it can be expressed with more detailed options.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> String<span class="token punctuation">,</span> minlength<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> maxlength<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  age<span class="token punctuation">:</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> Number<span class="token punctuation">,</span> min<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="schema-types"><a href="#schema-types" aria-hidden="true" class="header-anchor">#</a> Schema Types</h3> <p>The following <a href="https://mongoosejs.com/docs/schematypes.html" target="_blank" rel="noopener noreferrer">Mongoose Schema Types<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> are permitted:</p> <ul><li>Array</li> <li>Boolean</li> <li>Buffer</li> <li>Date</li> <li>Mixed (A generic / flexible data type)</li> <li>Number</li> <li>ObjectId</li> <li>String</li></ul> <p><strong>Mixed</strong> and <strong>ObjectId</strong> are defined under <code>mongoose.Schema.Types</code>. We will look at this a little later when we create an owner realationship for our cars API.</p> <h3 id="making-models"><a href="#making-models" aria-hidden="true" class="header-anchor">#</a> Making Models</h3> <p>First we need to use the schema object with the <code>model()</code> factory method to generate a new class.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Cat <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Cat'</span><span class="token punctuation">,</span> catSchema<span class="token punctuation">)</span>
</code></pre></div><p>... and then we can use that Cat model to instantiate a new mongoose document instance.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> kitty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Spot'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>The mongoose model class factory generates new class objects, customized with the given schema, that inherit all of the methods required to interact with the MongoDB service. This includes a list of <a href="https://mongoosejs.com/docs/queries.html" target="_blank" rel="noopener noreferrer">static class methods<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> as well as <a href="https://mongoosejs.com/docs/guide.html#methods" target="_blank" rel="noopener noreferrer">instance methods<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. e.g.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// example class method</span>
Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// example instance method</span>
kitty<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="relationships"><a href="#relationships" aria-hidden="true" class="header-anchor">#</a> Relationships</h3> <p>Most applications have more complex data structures that our simple Cat model. Often that involves a relationship to another model. For example we might want to extend our Cat model to include an owner. In traditional SQL database systems, this means creating a new table to store the details about the Person that is the owner of the Cat, and then adding a new property like <code>owner_id</code> to the Cat schema to store the foreign key pointer to <code>people.id</code>.</p> <p>Document databases like <a href="https://docs.mongodb.com/manual/applications/data-models-relationships/" target="_blank" rel="noopener noreferrer">MongoDB give us two options<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>: embedded documents, and document references.</p> <h4 id="document-references"><a href="#document-references" aria-hidden="true" class="header-anchor">#</a> Document References</h4> <p>Document references are similar to an SQL foriegn key. It stores the <code>_id</code> value of a document in another collection. Unlike SQL databases this relationship is not enforced at the database level -- there is no validation that the reference id exists. We would add it to the schema like this, where the <code>ref</code> option is the name of another model class in our application.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> String<span class="token punctuation">,</span> minlength<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> maxlength<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  age<span class="token punctuation">:</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> Number<span class="token punctuation">,</span> min<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  owner<span class="token punctuation">:</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span> ref<span class="token punctuation">:</span> <span class="token string">'Person'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Another difference from SQL is that the reference property could be an array.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> String<span class="token punctuation">,</span> minlength<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> maxlength<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  age<span class="token punctuation">:</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> Number<span class="token punctuation">,</span> min<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  owners<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span> ref<span class="token punctuation">:</span> <span class="token string">'Person'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="embeded-documents"><a href="#embeded-documents" aria-hidden="true" class="header-anchor">#</a> Embeded Documents</h4> <p>The other option is to embed the related documents as properties of the main document.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> personSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  firstName<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  lastName<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  phoneNumber<span class="token punctuation">:</span> Number
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> String<span class="token punctuation">,</span> minlength<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> maxlength<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  age<span class="token punctuation">:</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> Number<span class="token punctuation">,</span> min<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  owners<span class="token punctuation">:</span> <span class="token punctuation">[</span>personSchema<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> Cat <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Cat'</span><span class="token punctuation">,</span> catSchema<span class="token punctuation">)</span>

<span class="token keyword">const</span> kitty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'Fluffy'</span><span class="token punctuation">,</span>
  age<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  owners<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>firstName<span class="token punctuation">:</span> <span class="token string">'Mickey'</span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string">'Mouse'</span><span class="token punctuation">,</span> phoneNumber<span class="token punctuation">:</span> <span class="token number">14155551212</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>firstName<span class="token punctuation">:</span> <span class="token string">'Minni'</span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string">'Mouse'</span><span class="token punctuation">,</span> phoneNumber<span class="token punctuation">:</span> <span class="token number">14155551212</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">Tradeoffs</p> <p>The relationship modeling method you choose is ultimately a tradeoff between query speed and data consistency.</p></div> <p>The referenced documents method ensures that data remains consistent because it is stored in only one place for each schema model, but it requires an additional database query for each related document when retrieving the primary document. For queries returning a single document (most CRUD operations) this may be fine. However for complex search queries returning thousands of results, there could be a significant performance hit.</p> <p>The embeded document method avoids these additional database queries when retirieving data, but exponentially increases the complexity of maintaining data consistancy becuase we are storing the same data in many places and need to update them all.</p> <p>If we look at the Cat example above, and consider what happens when we want to change Mickey Mouse's phone number. In the reference method, we simply find the Person document for Mickey Mouse and update the phoneNumber property. Then whenever we need to contact Fluffy's owner, the data will be correct.</p> <p>However if we use the embed method, we have to lookup all of the Cats that have an owner with the name Mickey Mouse and then update the embeded phone number. But what if there is more than one Person named Mickey Mouse? How do we know if we are updating the correct information? It can get messy if we don't plan it out well.</p> <h2 id="mongoose-query-methods"><a href="#mongoose-query-methods" aria-hidden="true" class="header-anchor">#</a> Mongoose Query Methods</h2> <blockquote><p>Mongoose models provide several static helper functions for <strong>CRUD operations</strong>. Each of these functions returns a <a href="http://mongoosejs.com/docs/api.html#Query" target="_blank" rel="noopener noreferrer">mongoose Query object<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ... A query also has a <code>.then()</code> function, and thus can be used as a promise.</p></blockquote> <p>Review the <a href="https://mongoosejs.com/docs/queries.html" target="_blank" rel="noopener noreferrer">mongoose documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for the full list, but these are the most common ones that we will be using.</p> <p><a href="https://mongoosejs.com/docs/api.html#model_Model.find" target="_blank" rel="noopener noreferrer">Model.find()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is used to get an array of documents matching the given filter criteria.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> catsNamedSpot <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Spot'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>These methods act on a single document matching the given id parameter.</p> <ul><li>Model.findById()</li> <li>Model.findByIdAndRemove()</li> <li>Model.findByIdAndUpdate()</li></ul> <p>These methods act on the first document found matching the given filter criteria.</p> <ul><li>Model.findOne()</li> <li>Model.findOneAndRemove()</li> <li>Model.findOneAndUpdate()</li></ul> <h3 id="mongo-query-operators"><a href="#mongo-query-operators" aria-hidden="true" class="header-anchor">#</a> Mongo Query Operators</h3> <p>In the filter criteria objects we can use any of the standard <a href="https://docs.mongodb.com/manual/reference/operator/query/" target="_blank" rel="noopener noreferrer">MongoDB query operators<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. The syntax is to provide an object as the filter condition value for the given property. That object will have one of the Mongo query operators as it's key and the coresponding relative value. Let's look at some examples.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> catsAgedFourOrMore <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token punctuation">:</span> <span class="token punctuation">{</span>$gte<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> catsAgedLessThanFour <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token punctuation">:</span> <span class="token punctuation">{</span>$lt<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> catsAgedTwoFourOrSix <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token punctuation">:</span> <span class="token punctuation">{</span>$<span class="token keyword">in</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> catsNotAgedTwoFourOrSix <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token punctuation">:</span> <span class="token punctuation">{</span>$nin<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="mongoose-query-helpers"><a href="#mongoose-query-helpers" aria-hidden="true" class="header-anchor">#</a> Mongoose Query Helpers</h3> <p>Mongoose provides some <a href="https://mongoosejs.com/docs/api.html#Query" target="_blank" rel="noopener noreferrer">helper functions<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to make writing your queries more fluent. The syntax is sometimes more readable, but the end result is exactly the same. So, use whichever method is easier for you.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> catsAgedFourOrMore <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> catsAgedLessThanFour <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> catsAgedTwoFourOrSix <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">in</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> catsNotAgedTwoFourOrSix <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">nin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="ex6-1-mongo-cars"><a href="#ex6-1-mongo-cars" aria-hidden="true" class="header-anchor">#</a> EX6-1 Mongo Cars</h2> <p>We are going to recreate our Cars API with Mongoose and MongoDB. Let start by creating a new project folder. I called mine <code>week6</code>.</p> <div class="language-sh extra-class"><pre class="language-text"><code>mkdir week6
cd week6
touch app.js
npm init --yes
echo 'node_modules/' &gt; .gitignore
git init
</code></pre></div><h3 id="connect-to-mongodb"><a href="#connect-to-mongodb" aria-hidden="true" class="header-anchor">#</a> Connect to MongoDB</h3> <p>Before we can use Mongoose to connect to our MongoDB, we need to add it as an NPM dependency for our project.</p> <div class="language-sh extra-class"><pre class="language-text"><code>npm install mongoose
</code></pre></div><p>We only need to create the connection to MongoDB once in our application. We should do it in <code>app.js</code>, right at the top, before we initialize Express. If we cannot connect to the database, then we cannot proceed. So, we will use the <a href="https://nodejs.org/api/process.html#process_process_exit_code" target="_blank" rel="noopener noreferrer">process.exit([code])<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> function to terminate the node.js runtime.</p> <p>Just like last week, we require mongoose and then give it the connection string. This time the database path will be <code>/mad9124</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span>

<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
mongoose
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/mad9124'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>useNewUrlParser<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Connected to MongoDB ...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Problem connecting to MongoDB ...'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Let's add the rest of our <code>app.js</code> boilerplate code.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3030</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Server listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ...`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Make sure that <code>mongod</code> is running, and then if we run our app with <code>nodemon</code>, we should see a successful connection.</p> <img src="/assets/img/screenshot-mongoose-connect.cd925298.png" class="screenshot"> <h3 id="car-model"><a href="#car-model" aria-hidden="true" class="header-anchor">#</a> Car Model</h3> <p>Before we can do any CRUD operations we need to define a Mongoose.Schema and create a <code>Car</code> Model object. Create a new <code>models</code> folder at the top level of our project and in it create a new file called <code>Car.js</code> -- note the capital 'C' as a reminder that we will be exporting a class.</p> <p>The basic template for a Mongoose Model module is ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Model <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Car'</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Model
</code></pre></div><p>Let's expand the schema definition object on line three. We want to define three properties for our Car documents: <strong>make</strong>, <strong>model</strong> and <strong>colour</strong>. All will be of type <code>String</code>. An <strong>_id</strong> property with a unique value will be automatically assigned to all new documents.</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>Review the full list of <a href="https://mongoosejs.com/docs/schematypes.html" target="_blank" rel="noopener noreferrer">Mongoose Schema Types<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> in the official doumentation.</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  make<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  model<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  colour<span class="token punctuation">:</span> String
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="crud-with-mongoose"><a href="#crud-with-mongoose" aria-hidden="true" class="header-anchor">#</a> CRUD with Mongoose</h3> <p>OK, we have a working connection from our Express app to the MongoDB server in our development environment. Now let's setup the API rotues to talk to the database instead of an in memory array.</p> <p>Create a <code>routes</code> folder and in that folder create a new file called <code>cars.js</code> and stub out our six route handlers.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>Since the only time we are using <code>express</code> in this module is to create a router instance. We can directly request the <code>Router()</code> method and imediately invoke it. So this code ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Can be simplified to this code ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>But you can certainly write it out the long way if that makes it easier to read for you.</p></div> <p>Now let's register the cars router in our main <code>app.js</code> after the <code>express.json()</code> middleware.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br></div><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/cars'</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/cars'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="get-api-cars"><a href="#get-api-cars" aria-hidden="true" class="header-anchor">#</a> GET /api/cars</h3> <p>We can use the <code>find()</code> mehtod to query the Car model for a list all of the cars in the collection. Before we can do that, we need to import the <code>Car</code> model class.</p> <p>Put this right at the top of <code>/routes/cars.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Car <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/Car'</span><span class="token punctuation">)</span>
</code></pre></div><p>And then we'll update our route handler ...</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cars <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> cars<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>Notice the async/await syntax.</p></div> <p>OK. Let's test that in Postman. We should see a status code 200 response with an empty array for the data payload.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>That was easy! Let's do the POST route now so that we can add some cars to the database.</p> <h3 id="post-api-cars"><a href="#post-api-cars" aria-hidden="true" class="header-anchor">#</a> POST /api/cars</h3> <p>Use the <code>req.body</code> as input to create a new instance of the Car model class. Then call the <code>.save()</code> method on that instance to perist it to the database. But first we need to ensure that the client did not try to set the <code>_id</code> value, so we will use the JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/delete" target="_blank" rel="noopener noreferrer">delete<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> operator to remove the <code>_id</code> property if it exists.</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> attributes <span class="token operator">=</span> req<span class="token punctuation">.</span>body
  <span class="token keyword">delete</span> attributes<span class="token punctuation">.</span>_id

  <span class="token keyword">let</span> newCar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span>
  <span class="token keyword">await</span> newCar<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> newCar<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>Mongoose models will automatically discard any properties that are not defined in the Model.schema, so our route handler does not need to worry about extracting only permitted properties from the <code>req.body</code> as we had done in week 4.</p></div> <h3 id="get-api-cars-id"><a href="#get-api-cars-id" aria-hidden="true" class="header-anchor">#</a> GET /api/cars/:id</h3> <p>First let's do the happy path ... no error handling. We can use the <code>.findById()</code> static method on the Car model class.</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> car<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>OK, now what if the <code>:id</code> does not exist as a unique identifier in our database? We should wrap our code in a <code>try/catch</code> block and then send the appropriate error response back to the client.</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> car<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      errors<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          status<span class="token punctuation">:</span> <span class="token string">'Not Found'</span><span class="token punctuation">,</span>
          code<span class="token punctuation">:</span> <span class="token string">'404'</span><span class="token punctuation">,</span>
          title<span class="token punctuation">:</span> <span class="token string">'Resource does not exist'</span><span class="token punctuation">,</span>
          description<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`We could not find a car with id: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>As we have seen before, we will need this same error handler in several other routes. Lets extract this to a function. At the bottom of the <code>/routes/cars.js</code> module, but just above the <code>module.exports</code> line, add this private function.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    errors<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        status<span class="token punctuation">:</span> <span class="token string">'Not Found'</span><span class="token punctuation">,</span>
        code<span class="token punctuation">:</span> <span class="token string">'404'</span><span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">'Resource does not exist'</span><span class="token punctuation">,</span>
        description<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`We could not find a car with id: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><p>... and then update our route handler's catch block to call this function.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> car<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="patch-api-cars-id"><a href="#patch-api-cars-id" aria-hidden="true" class="header-anchor">#</a> PATCH /api/cars/:id</h3> <p>For our update actions, we will use the <code>findByIdAndUpdate()</code> static method on the Car model class. Similar to the <code>findById()</code> method, it takes a document <code>_id</code> value as the first argument. The second argument is an object with the properties to be stored. The third argument is an options object.</p> <h4 id="second-argument"><a href="#second-argument" aria-hidden="true" class="header-anchor">#</a> Second argument</h4> <p>To ensure that the <code>_id</code> property matches the <code>req.params.id</code> and has not been modified (accidentally or maliciously), we will use object destructuring to separate and discard any <code>_id</code> property that may be included in the <code>req.body</code>. We will then reconstruct the update object, explicitly setting <code>_id: req.params.id</code> and then use the rest operator to extract the remaining attributes.</p> <h4 id="options-object"><a href="#options-object" aria-hidden="true" class="header-anchor">#</a> Options object</h4> <p>The documentation lists many options that can be set to modify the behaviour of the update method. We are interested in two.</p> <ol><li><p>Setting <code>new</code> to <code>true</code> will return the updated record from the database. The default behaviour returns the document in it's pre-update state.</p></li> <li><p>Setting <code>runValidators</code> to <code>true</code> ensures that our Model.schema rules are checked before the updates are applied.</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>_id<span class="token punctuation">,</span> <span class="token operator">...</span>otherAttributes<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>
      req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>_id<span class="token punctuation">:</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token operator">...</span>otherAttributes<span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">new</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        runValidators<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> car<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="put-api-cars-id"><a href="#put-api-cars-id" aria-hidden="true" class="header-anchor">#</a> PUT /api/cars/:id</h3> <p>By calling the PUT method, the client is asking us to replace the current document with the one suplied in the <code>req.body</code>. The route handler is identical to the PATH method with one additional property in the options object.</p> <p>Set the <code>overwrite</code> option to <code>true</code>.</p> <p>This will update any supplied document properties the same as with the PATCH mehtod, but any document properties that are omitted from the <code>req.body</code> will be removed from the database.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>_id<span class="token punctuation">,</span> <span class="token operator">...</span>otherAttributes<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>
      req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>_id<span class="token punctuation">:</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token operator">...</span>otherAttributes<span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">new</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        runValidators<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> car<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="delete-api-cars-id"><a href="#delete-api-cars-id" aria-hidden="true" class="header-anchor">#</a> DELETE /api/cars/:id</h3> <p>This time we want the <code>findByIdAndRemove()</code> static method on the Car model class.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findByIdAndRemove</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> car<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>That's it! We have recreated the cars API from week 4 using MongoDB and Mongoose.</p> <h2 id="ex6-2-car-owner"><a href="#ex6-2-car-owner" aria-hidden="true" class="header-anchor">#</a> EX6-2 Car Owner</h2> <p>In real life, cars have owners. Let's extend our API to include a <code>/api/people</code> resource path, and link the Person and Car models by the reference method.</p> <h3 id="person-model"><a href="#person-model" aria-hidden="true" class="header-anchor">#</a> Person Model</h3> <p>Create a new file called <code>Person.js</code> in the <code>/models</code> folder.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    first<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    last<span class="token punctuation">:</span> String
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  email<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  birthDate<span class="token punctuation">:</span> Date<span class="token punctuation">,</span>
  phone<span class="token punctuation">:</span> Number<span class="token punctuation">,</span>
  address<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    streetNumber<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    streetName<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    city<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    region<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    country<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    postalCode<span class="token punctuation">:</span> String
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Model <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Person'</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Model
</code></pre></div><h3 id="update-car-model-schema"><a href="#update-car-model-schema" aria-hidden="true" class="header-anchor">#</a> Update Car Model.schema</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  make<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  model<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  colour<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  owner<span class="token punctuation">:</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span> ref<span class="token punctuation">:</span> <span class="token string">'Person'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Also, right at the top we need to require the Person model so that Mongoose knows about it. This model would normally be loaded into our application in the people router module, but we haven't built that yet.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Person <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Person'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="populate-owner"><a href="#populate-owner" aria-hidden="true" class="header-anchor">#</a> Populate owner</h3> <p>To expand the reference <code>_id</code> value for the <code>owner</code> property, we need to use the Mongoose <a href="https://mongoosejs.com/docs/populate.html" target="_blank" rel="noopener noreferrer">.populate()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> mehtod.</p> <blockquote><p>Populated paths are no longer set to their original <code>_id</code> , their value is replaced with the mongoose document returned from the database by performing a separate query before returning the results.</p></blockquote> <p>In our <code>/routes/cars.js</code> file, update the <strong>GET /:id</strong> route handler to chain the <code>.populate('owner')</code> mehtod onto the <code>findById()</code> method call.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">'owner'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span> car<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">Let's test it!</p> <p>Before we can test this out, there needs to be people in the database, and we need to either add a new car with an owner property or update one.</p></div> <h4 id="mannualy-add-people-collection"><a href="#mannualy-add-people-collection" aria-hidden="true" class="header-anchor">#</a> Mannualy add people collection</h4> <p>Using MongoDB Compass we can mannualy create the <code>people</code> collection and add a document.</p> <ol><li>Select on the <code>mad9124</code> database in the left sidebar.</li> <li>Click on the <code>Create Collection</code> button.</li> <li>Type the collection name as <code>people</code> -- all lowercase.</li> <li>Click the green <code>Create Collection</code> button.</li></ol> <p><img src="/assets/img/screenshot-compass-create-collection.7097a793.png" alt="screenshot of MongoDB compass"> <img src="/assets/img/screenshot-compass-collection-name.493ca9eb.png" alt="screenshot of MongoDB compass"> <img src="/assets/img/screenshot-compass-collection-list.545687be.png" alt="screenshot of MongoDB compass"></p> <h4 id="mannually-add-a-person-document"><a href="#mannually-add-a-person-document" aria-hidden="true" class="header-anchor">#</a> Mannually add a Person document</h4> <ol><li>Click on the newly created <code>people</code> collection in the collection list.</li> <li>Click on the green <code>Insert Document</code> button.</li> <li>Add the properties and values for your Person document.</li> <li>Click the green <code>Insert</code> button.</li></ol> <p><img src="/assets/img/screenshot-compass-insert-document.88b525e0.png" alt="screenshot of MongoDB compass"></p> <h4 id="update-a-car-document"><a href="#update-a-car-document" aria-hidden="true" class="header-anchor">#</a> Update a Car document</h4> <p>Now that we have a Person in the database we can link that document as an owner reference in one of our Car documents. Use Postman to do a PATCH update on one of your Car documents with the <code>_id</code> value from your new Person document as the value for the <code>owner</code> property of the car.</p> <p><img src="/assets/img/screenshot-compass-person-document.16e100d4.png" alt="screenshot of MongoDB compass"> <img src="/assets/img/screenshot-postman-patch-owner.d7dba67f.png" alt="screenshot of Postman PATCH request"></p> <h4 id="test-the-get-api-cars-id-route"><a href="#test-the-get-api-cars-id-route" aria-hidden="true" class="header-anchor">#</a> Test the GET /api/cars/:id route</h4> <p>Now that we have a Car document with an <code>owner</code> property linked to a Person document, we can finally test the <code>.populate()</code> instruction that we added to the <strong>GET /api/cars/:id</strong> route handler.</p> <p>You should see the <code>owner</code> property has been expanded to include the entire related Person document.</p> <p><img src="/assets/img/screenshot-postman-get-car.1ac00981.png" alt="screenshot of Postman GET request"></p> <h3 id="people-router"><a href="#people-router" aria-hidden="true" class="header-anchor">#</a> People Router</h3> <p>Now that you have seen how to implement the cars router module. Use that as a template to implement the people router module on your own.</p> <p>Create a new <code>/routes/people.js</code> file to implement a router module for the <code>/api/people</code> resource path. Be sure to require the Person model in your router module. Then register the router in the main <code>app.js</code> file.</p> <p>Test all of the routes with Postman.</p> <h3 id="submit-github-repo"><a href="#submit-github-repo" aria-hidden="true" class="header-anchor">#</a> Submit GitHub Repo</h3> <p>Create a new private repo on GitHub named mad9124-ex6-userid (please substitute <strong>your college userid</strong>. i.e. mine would look like mad9124-ex6-mckennr).</p> <p>Make sure that you have initialized your local project folder with <code>git init</code> and created a <code>.gitignore</code> file to exclude the <code>node_modules</code> folder from your git archive.</p> <p>Create a commit to include all of your work from today's exercises.</p> <p>Link the local repo to the GitHub repo and sync them up.</p> <p>Remember to add me as a collaborator on your GitHub repo so that I can see your code, and submit the GitHub repo's URL on Bright Space.</p> <h2 id="for-next-class"><a href="#for-next-class" aria-hidden="true" class="header-anchor">#</a> For next class</h2> <p>Before next class, please read these additional online resources.</p> <ul><li><a href="https://medium.freecodecamp.org/introduction-to-mongoose-for-mongodb-d2a7aa593c57" target="_blank" rel="noopener noreferrer">Introduction to Mongoose for MongoDB<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://mongoosejs.com/docs/queries.html" target="_blank" rel="noopener noreferrer">Mongoose Guide: Queries<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.mongodb.com/manual/reference/operator/query/" target="_blank" rel="noopener noreferrer">MongoDB query operators<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://mongoosejs.com/docs/api.html#Query" target="_blank" rel="noopener noreferrer">Mongoose query helper functions<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://mongoosejs.com/docs/schematypes.html" target="_blank" rel="noopener noreferrer">Mongoose Schema Types<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://nodejs.org/api/process.html#process_process_exit_code" target="_blank" rel="noopener noreferrer">process.exit([code])<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="warning custom-block"><p class="custom-block-title">REMINDER: Midterm after the break</p> <p>Next week is break week. The following week will be our Midterm Test. The questions could come from any of the material referenced in the first 6 weeks of this course. Review these notes and the linked reading material. You should also review your previous quiz results.</p></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2/15/2019, 11:17:29 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/modules/week5/" class="prev">
          Week 5: Data persistance
        </a></span> <span class="next"><a href="/modules/break-week/">
          Break Week: 18 FEB - 22 FEB
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/26.4bdddc91.js" defer></script><script src="/assets/js/3.bf2a64fb.js" defer></script><script src="/assets/js/5.d875dd4e.js" defer></script><script src="/assets/js/app.71c37e52.js" defer></script>
  </body>
</html>
