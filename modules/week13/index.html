<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 13: Production Deployment | MAD9124</title>
    <meta name="description" content="Mobile API Development">
    
    
    <link rel="preload" href="/assets/css/0.styles.084d7c4c.css" as="style"><link rel="preload" href="/assets/js/app.71c37e52.js" as="script"><link rel="preload" href="/assets/js/19.59eeaff9.js" as="script"><link rel="preload" href="/assets/js/3.bf2a64fb.js" as="script"><link rel="preload" href="/assets/js/5.d875dd4e.js" as="script"><link rel="prefetch" href="/assets/js/2.6573b30c.js"><link rel="prefetch" href="/assets/js/4.db9b657e.js"><link rel="prefetch" href="/assets/js/6.c8e95fd0.js"><link rel="prefetch" href="/assets/js/7.38090071.js"><link rel="prefetch" href="/assets/js/8.bbb7f9ec.js"><link rel="prefetch" href="/assets/js/9.4519aded.js"><link rel="prefetch" href="/assets/js/10.0fd3f93c.js"><link rel="prefetch" href="/assets/js/11.ae8c26a3.js"><link rel="prefetch" href="/assets/js/12.57f9b125.js"><link rel="prefetch" href="/assets/js/13.a589cf42.js"><link rel="prefetch" href="/assets/js/14.3119106c.js"><link rel="prefetch" href="/assets/js/15.c6f416e9.js"><link rel="prefetch" href="/assets/js/16.60cf80b9.js"><link rel="prefetch" href="/assets/js/17.e03883a2.js"><link rel="prefetch" href="/assets/js/18.ca360324.js"><link rel="prefetch" href="/assets/js/20.0d907809.js"><link rel="prefetch" href="/assets/js/21.d1a45bec.js"><link rel="prefetch" href="/assets/js/22.56312e0c.js"><link rel="prefetch" href="/assets/js/23.901d07dd.js"><link rel="prefetch" href="/assets/js/24.c90462b4.js"><link rel="prefetch" href="/assets/js/25.0c2b62eb.js"><link rel="prefetch" href="/assets/js/26.4bdddc91.js"><link rel="prefetch" href="/assets/js/27.894b645a.js"><link rel="prefetch" href="/assets/js/28.82a5b267.js"><link rel="prefetch" href="/assets/js/29.a60cef02.js"><link rel="prefetch" href="/assets/js/30.21c01a63.js"><link rel="prefetch" href="/assets/js/31.607866af.js"><link rel="prefetch" href="/assets/js/32.59c25f3c.js"><link rel="prefetch" href="/assets/js/33.996c9705.js"><link rel="prefetch" href="/assets/js/34.6923aabe.js"><link rel="prefetch" href="/assets/js/35.089a238b.js"><link rel="prefetch" href="/assets/js/36.17d82978.js">
    <link rel="stylesheet" href="/assets/css/0.styles.084d7c4c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/overview/" class="nav-link">Overview</a></div><div class="nav-item"><a href="/deliverables/" class="nav-link">Deliverables</a></div><div class="nav-item"><a href="/modules/" class="nav-link router-link-active">Modules</a></div><div class="nav-item"><a href="/resources/" class="nav-link">Resources</a></div><div class="nav-item"><a href="https://classroom.github.com/classrooms/46425465-mobile-api-development" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/overview/" class="nav-link">Overview</a></div><div class="nav-item"><a href="/deliverables/" class="nav-link">Deliverables</a></div><div class="nav-item"><a href="/modules/" class="nav-link router-link-active">Modules</a></div><div class="nav-item"><a href="/resources/" class="nav-link">Resources</a></div><div class="nav-item"><a href="https://classroom.github.com/classrooms/46425465-mobile-api-development" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/modules/" class="sidebar-link">Table of contents</a></li><li><a href="/modules/week1/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/modules/week2/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/modules/week3/" class="sidebar-link">Week 3: RESTful APIs</a></li><li><a href="/modules/week4/" class="sidebar-link">Week 4: Middleware functions</a></li><li><a href="/modules/week5/" class="sidebar-link">Week 5: Data persistance</a></li><li><a href="/modules/week6/" class="sidebar-link">Week 6: Object Data Modeling</a></li><li><a href="/modules/break-week/" class="sidebar-link">Break Week: 18 FEB - 22 FEB</a></li><li><a href="/modules/week7/" class="sidebar-link">Week 7: Data security</a></li><li><a href="/modules/week8/" class="sidebar-link">Week 8: Access Control with JWT</a></li><li><a href="/modules/week9/" class="sidebar-link">Week 9: JWT Review</a></li><li><a href="/modules/week10/" class="sidebar-link">Week 10: Consistent Error Handling</a></li><li><a href="/modules/week11/" class="sidebar-link">Week 11: Production Preparation</a></li><li><a href="/modules/week12/" class="sidebar-link">Week 12: Testing</a></li><li><a href="/modules/week13/" class="active sidebar-link">Week 13: Production Deployment</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/week13/#errata" class="sidebar-link">ERRATA</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/week13/#jwt-client-headers" class="sidebar-link">JWT Client Headers</a></li><li class="sidebar-sub-header"><a href="/modules/week13/#authenticate-middleware" class="sidebar-link">Authenticate middleware</a></li></ul></li><li class="sidebar-sub-header"><a href="/modules/week13/#hosted-mongodb" class="sidebar-link">Hosted MongoDB</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/week13/#credentials" class="sidebar-link">Credentials</a></li><li class="sidebar-sub-header"><a href="/modules/week13/#mongodb-connection-string" class="sidebar-link">MongoDB Connection String</a></li><li class="sidebar-sub-header"><a href="/modules/week13/#update-the-connectdatabase-module" class="sidebar-link">Update the ConnectDatabase Module</a></li></ul></li><li class="sidebar-sub-header"><a href="/modules/week13/#deploy-to-edumedia" class="sidebar-link">Deploy to Edumedia</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/modules/week13/#replace-bcrypt-with-bcryptjs" class="sidebar-link">Replace bcrypt with bcryptjs</a></li><li class="sidebar-sub-header"><a href="/modules/week13/#login-to-control-panel" class="sidebar-link">Login to control panel</a></li><li class="sidebar-sub-header"><a href="/modules/week13/#ftp-to-root-folder" class="sidebar-link">FTP to root folder</a></li><li class="sidebar-sub-header"><a href="/modules/week13/#setup-the-node-application" class="sidebar-link">Setup the Node application</a></li><li class="sidebar-sub-header"><a href="/modules/week13/#npm-install" class="sidebar-link">NPM install</a></li><li class="sidebar-sub-header"><a href="/modules/week13/#port-80" class="sidebar-link">Port 80</a></li></ul></li><li class="sidebar-sub-header"><a href="/modules/week13/#for-next-week" class="sidebar-link">For next week</a></li></ul></li><li><a href="/modules/week14/" class="sidebar-link">Week 14: Advanced topics</a></li><li><a href="/modules/week15/" class="sidebar-link">Week 15: Remedial Lab</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1><span class="week">Week 13</span><br> <span class="title">Production Deployment</span></h1> <div class="danger custom-block"><p class="custom-block-title">Quiz 9: Production Prep <span class="badge tip top" data-v-099ab69c>15 mins</span></p> <p>There will be a quiz today. It will be worth 2% of your final grade.</p></div> <div class="warning custom-block"><p class="custom-block-title">Assignment Reminder</p> <p>Final project - Shopping Cart - is due by <strong>11:59 April 26, 2019</strong>.</p></div> <h2 id="errata"><a href="#errata" aria-hidden="true" class="header-anchor">#</a> ERRATA</h2> <h3 id="jwt-client-headers"><a href="#jwt-client-headers" aria-hidden="true" class="header-anchor">#</a> JWT Client Headers</h3> <div><p>The previous instructions for sending the JWT in request headers was not formatted correctly. The correct header key is <code>Authorization</code> not <code>bearer</code>. The corresponding value should take the form of <code>Bearer {{token}}</code>, where <code>{{token}}</code> is a placeholder for the actual token. Note the word Bearer is capitalized and followed be a space.</p></div> <p>In Postman it looks like this ...</p> <p><img src="/assets/img/screenshot-postman-authorization-header.a049c04a.png" alt="screenshot of Postman showing the Authorization header"></p> <p>In your JavaScript client app it would look like this ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Create a Headers object with the 'Content-Type' set to JSON</span>
<span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
headers<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/json;charset=UTF-8'</span><span class="token punctuation">)</span>
<span class="token comment">// Set the 'Authorization' header if we have a token</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>authToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  headers<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">,</span> <span class="token string">'Bearer '</span> <span class="token operator">+</span> authToken<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="authenticate-middleware"><a href="#authenticate-middleware" aria-hidden="true" class="header-anchor">#</a> Authenticate middleware</h3> <p>Naturally, we now need to extract and validate the JWT from the request headers a little differently. Not only has the name of the header key changed from <code>bearer</code> to <code>Authorization</code>, but the value is now a string with two parts.</p> <p>The first part is the token type <code>Bearer</code> and the second part – after the space – is the actual token. We can use JavaScript's <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/split" target="_blank" rel="noopener noreferrer">String.prototype.split()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to issolate these two values as elements of an array. Then we can apply <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment" target="_blank" rel="noopener noreferrer">destructuring assignment<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to to extract the first two elements of the array into local variables, <code>type</code> and <code>token</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">[</span>type<span class="token punctuation">,</span> token<span class="token punctuation">]</span> <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
</code></pre></div><p>To keep things clean and organized, let's move the logic to parse the Authorization header into a separate function.</p> <h4 id="previous-code"><a href="#previous-code" aria-hidden="true" class="header-anchor">#</a> Previous code</h4> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'bearer'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NotAuthenticatedException</span><span class="token punctuation">(</span><span class="token string">'Missing bearer token'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// ... rest of the module</span>
</code></pre></div><h4 id="updated-code"><a href="#updated-code" aria-hidden="true" class="header-anchor">#</a> Updated code</h4> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">parseToken</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>header<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>header<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>type<span class="token punctuation">,</span> token<span class="token punctuation">]</span> <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'Bearer'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> token <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> token
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> undefined
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">parseToken</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NotAuthenticatedException</span><span class="token punctuation">(</span><span class="token string">'Missing bearer token'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// ... rest of the module</span>
</code></pre></div><h2 id="hosted-mongodb"><a href="#hosted-mongodb" aria-hidden="true" class="header-anchor">#</a> Hosted MongoDB</h2> <p>I have deployed a shared MongoDB server container running on an AWS Lightsail VPS. Each project team has been assigned unique login credentials that have access restricted to their own private database.</p> <h3 id="credentials"><a href="#credentials" aria-hidden="true" class="header-anchor">#</a> Credentials</h3> <p>You will receive an email with the connection details for your project team.</p> <h3 id="mongodb-connection-string"><a href="#mongodb-connection-string" aria-hidden="true" class="header-anchor">#</a> MongoDB Connection String</h3> <p>Up until now, the connection string to tell Mongoose how to open a connection to the database took this format:</p> <div class="language- extra-class"><pre class="language-text"><code>mongodb://hostname:port/database-name
</code></pre></div><p>e.g.</p> <div class="language- extra-class"><pre class="language-text"><code>mongodb://localhost:27017/mad9124
</code></pre></div><h4 id="production-server"><a href="#production-server" aria-hidden="true" class="header-anchor">#</a> Production server</h4> <p>The <code>hostname</code> for the production database is <code>mongodb.mad9124.rocks</code>.</p> <p>In addition to a different <code>hostname</code>, the production server requires use to specify a <code>username</code> and <code>password</code> pair along with the name of the authentication database where the credentials are stored. The connection string should now follow this pattern.</p> <div class="language- extra-class"><pre class="language-text"><code>mongodb://username:password@hostname:27017/database-name?authSource=admin
</code></pre></div><h3 id="update-the-connectdatabase-module"><a href="#update-the-connectdatabase-module" aria-hidden="true" class="header-anchor">#</a> Update the <code>ConnectDatabase</code> Module</h3> <p>Remember we are retrieving the configuration variables using the <code>config.get()</code> method. You will need to create a new <code>/config/production.json</code> file with your credtentials. e.g.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;db&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mongodb.mad9124.rocks&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mckennr&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;supeRsecreTpassworD&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;final-mckennr&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then in the <code>/startup/connectDatabase.js</code> module, we need to conditionally add the login credentials to the connection string if <code>NODE_NEV</code> is set to <code>production</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'config'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./logger'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> db <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'db'</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> credentials <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    credentials <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>db<span class="token punctuation">.</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>db<span class="token punctuation">.</span>password<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@`</span></span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> connectionString <span class="token operator">=</span> <span class="token template-string"><span class="token string">`mongodb://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>credentials<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>db<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>db<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>db<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?authSource=admin`</span></span>

<span class="token comment">// ... rest of the module is unchanged.</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>Don't forget we need to make sure that the NODE_ENV environment variable gets set to <code>production</code> on our production deployment. We will set this a little later in the Edumedia control panel.</p></div> <h2 id="deploy-to-edumedia"><a href="#deploy-to-edumedia" aria-hidden="true" class="header-anchor">#</a> Deploy to Edumedia</h2> <h3 id="replace-bcrypt-with-bcryptjs"><a href="#replace-bcrypt-with-bcryptjs" aria-hidden="true" class="header-anchor">#</a> Replace bcrypt with bcryptjs</h3> <p>You will host your final web service API application code with your Edumedia account. However, the Edumedia server's node.js environment has a configuration that causes a the <code>bcrypt</code> module's installation to fail. As a work-around, we will replace this module with the <a href="https://www.npmjs.com/package/bcryptjs" target="_blank" rel="noopener noreferrer">bcryptjs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> module, which is 100% API compatible but runs about 30% slower.</p> <p>In your project folder on your laptop, run these terminal commands.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> uninstall bcrypt
<span class="token function">npm</span> <span class="token function">install</span> bcryptjs
</code></pre></div><p>Then in <code>/models/User.js</code>, you will need to change the require statement to load the new module.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcryptjs'</span><span class="token punctuation">)</span>
</code></pre></div><p>Save your changes.</p> <h3 id="login-to-control-panel"><a href="#login-to-control-panel" aria-hidden="true" class="header-anchor">#</a> Login to control panel</h3> <p>Go to <a href="https://edumedia.ca:8443" target="_blank" rel="noopener noreferrer">https://edumedia.ca:8443<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to login to the hosting admin panel. You will see a login form.</p> <img src="/assets/img/screenshot-plesk-login.a0a7367d.png" alt="screenshot of Plesk login dialog" class="screenshot" style="max-width: 400px; margin: 0 20%;"> <p>Use your Algonquin user name (e.g. mine is mckennr). If you have not logged-in before or cannot remember your password, click the &quot;Forgot your password?&quot; link and they will send you a reset link to your Algonquin email.</p> <p>Once you are logged-in, you will see the main control panel. It should look similar to this.</p> <p><img src="/assets/img/screenshot-plesk-main-panel.b9a5c968.png" alt="screenshot of Plesk main panel"></p> <p>We will come back to this in just a minute.</p> <h3 id="ftp-to-root-folder"><a href="#ftp-to-root-folder" aria-hidden="true" class="header-anchor">#</a> FTP to root folder</h3> <p>Now that you have verified that you can login to the Edumedia server, use your favourite FTP client application (CyberDuck, Filezilla, etc.) to login. I will use CyberDuck for this example.</p> <p>Create a new server connection ...</p> <p><img src="/assets/img/screenshot-cyberduck-connection.99723c29.png" alt></p> <p>Then double click the new connection to login. You may see a security warning ...</p> <p><img src="/assets/img/screenshot-cyberduck-security-warning.a677fd82.png" alt></p> <p>Just click continue and enter your password when prompted.</p> <p><img src="/assets/img/screenshot-cyberduck-login.098c1985.png" alt></p> <p>You should now be logged-in to edumedia.ca via FTP. Make sure that the current folder is set to the root of your user acocunt i.e. <code>/</code></p> <p><img src="/assets/img/screenshot-cyberduck-root-folder.404a3975.png" alt></p> <p>Now you can &quot;drag and drop&quot; your project files into the root folder on your Edumedia account.</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>Do not copy the <code>node_modules</code> folder or the <code>package-lock.json</code> file.</p></div> <p><img src="/assets/img/screenshot-finder-file-selection.964b3266.png" alt></p> <h3 id="setup-the-node-application"><a href="#setup-the-node-application" aria-hidden="true" class="header-anchor">#</a> Setup the Node application</h3> <p>Once the FTP upload is complete, you can go back to the Plesk control panel in your browser. Click on the &quot;Node.js&quot; link near the middle of the page.</p> <p>You need to configure the options on this page carefully. When you are done, it should look similar to mine.</p> <p><img src="/assets/img/screenshot-plesk-node-app.70f9fd8d.png" alt></p> <p>Let's take these settings one at a time.</p> <h4 id="node-js-version"><a href="#node-js-version" aria-hidden="true" class="header-anchor">#</a> Node.js Version</h4> <p>Select version <code>9.10.1</code></p> <h4 id="document-root"><a href="#document-root" aria-hidden="true" class="header-anchor">#</a> Document Root</h4> <p>Select <code>/httpdocs</code></p> <h4 id="application-mode"><a href="#application-mode" aria-hidden="true" class="header-anchor">#</a> Application Mode</h4> <p>Edumedia uses Passenger Phusion to run our Node apps. Leave this setting at <code>development</code> to be able to see error message if there are any. You will not have access to the console.</p> <h4 id="application-url"><a href="#application-url" aria-hidden="true" class="header-anchor">#</a> Application URL</h4> <p>This should be in the form of http://username.edumedia.ca where <code>username</code> is your Algonquin username that you used to login to the control panel.</p> <h4 id="application-root"><a href="#application-root" aria-hidden="true" class="header-anchor">#</a> Application Root</h4> <p>This must be <code>/</code>. This is where you uploaded your project files with FTP.</p> <h4 id="application-startup-file"><a href="#application-startup-file" aria-hidden="true" class="header-anchor">#</a> Application Startup File</h4> <p>This should be the main entry point for your API server. i.e. <code>app.js</code></p> <h4 id="custom-environment-variables"><a href="#custom-environment-variables" aria-hidden="true" class="header-anchor">#</a> Custom environment variables</h4> <p>This is where we will set any environement variables that you might need to reference in your code. Click the <code>[specify]</code> link and then add the <code>key</code> : <code>value</code> pairs. At the minimum, you will need to set <code>APP_JWTKEY</code> and <code>NODE_ENV</code>. To generate a random string for the JWT secret key, you can use the genKey.js script that I gave you in week 11, or you can run this command in the terminal.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>openssl rand -base64 30
</code></pre></div><table><thead><tr><th>key</th> <th>value</th></tr></thead> <tbody><tr><td>APP_JWTKEY</td> <td>PJ20vdDET6/8QmSE7VkYiGN1FIuOmjFYKN3gRbZ9</td></tr> <tr><td>NODE_ENV</td> <td>production</td></tr></tbody></table> <h3 id="npm-install"><a href="#npm-install" aria-hidden="true" class="header-anchor">#</a> NPM install</h3> <p>With Edumedia, you do not have access to the command line environment. Near the top of the screen there is a button to let you run <code>NPM install</code>. Click on that. It may take a short time to complete. When it is done, click on the <code>Restart App</code> button.</p> <p><img src="/assets/img/screenshot-plesk-node-app-npm.71b9e878.png" alt="screenshot highlighting NPM install button on plesk node app"></p> <h3 id="port-80"><a href="#port-80" aria-hidden="true" class="header-anchor">#</a> Port 80</h3> <p>You should now be able to run your Postman tests by setting the URL in Postman to <code>http://your-username.edumedia.ca</code>. Note that the Edumedia server is running an Apache web server in front of your application as a reverse proxy. The port that you should use with Postman and in your client application is port 80.</p> <h2 id="for-next-week"><a href="#for-next-week" aria-hidden="true" class="header-anchor">#</a> For next week</h2> <p>Before next week's class, please read these additional online resources.</p> <ul><li><a href="https://docs.docker.com/engine/docker-overview/" target="_blank" rel="noopener noreferrer">Docker overview<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.youtube.com/watch?v=YFl2mCHdv24" target="_blank" rel="noopener noreferrer">Learn Docker in 12 Minutes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.youtube.com/watch?v=Qw9zlE3t8Ko" target="_blank" rel="noopener noreferrer">Docker Compose in 12 Minutes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.youtube.com/watch?v=F82K07NmRpk" target="_blank" rel="noopener noreferrer">Deploy Docker Containers with Docker Cloud<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/23/2019, 1:13:33 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/modules/week12/" class="prev">
          Week 12: Testing
        </a></span> <span class="next"><a href="/modules/week14/">
          Week 14: Advanced topics
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/19.59eeaff9.js" defer></script><script src="/assets/js/3.bf2a64fb.js" defer></script><script src="/assets/js/5.d875dd4e.js" defer></script><script src="/assets/js/app.71c37e52.js" defer></script>
  </body>
</html>
